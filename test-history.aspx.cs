using System;
using System.Web.UI.WebControls;
using System.Configuration;
using Npgsql;

public partial class shynet_test_history : System.Web.UI.Page
{
    private string CONNECTION_STRING = ConfigurationManager.ConnectionStrings["Heroku"].ToString();
    
    protected void Page_Load(object sender, EventArgs e)
    {
        if (!IsPostBack)
        {
            // Populate dropdowns only once using ViewState to retain their contents
            NpgsqlConnection conn = new NpgsqlConnection(CONNECTION_STRING);
            conn.Open();

            NpgsqlCommand cmd = new NpgsqlCommand("SELECT id, name FROM old_classes WHERE active=true ORDER BY name", conn);
            NpgsqlDataReader reader = cmd.ExecuteReader();
            lstClass.DataSource = reader;
            lstClass.DataTextField = "name";
            lstClass.DataValueField = "id";
            lstClass.DataBind();
            reader.Close();

            cmd = new NpgsqlCommand("SELECT id, lastname || ', ' || firstname AS name FROM old_instructors WHERE active=true ORDER BY lastname", conn);
            reader = cmd.ExecuteReader();
            lstInstructor.DataSource = reader;
            lstInstructor.DataTextField = "name";
            lstInstructor.DataValueField = "id";
            lstInstructor.DataBind();
            reader.Close();

            cmd = new NpgsqlCommand("SELECT id, name FROM old_locations WHERE active=true ORDER BY name", conn);
            reader = cmd.ExecuteReader();
            lstLocation.DataSource = reader;
            lstLocation.DataTextField = "name";
            lstLocation.DataValueField = "id";
            lstLocation.DataBind();
            reader.Close();

            cmd = new NpgsqlCommand("SELECT id, name FROM old_payment_types WHERE active=true ORDER BY ordinal", conn);
            reader = cmd.ExecuteReader();
            lstPaymentType.DataSource = reader;
            lstPaymentType.DataTextField = "name";
            lstPaymentType.DataValueField = "id";
            lstPaymentType.DataBind();
            reader.Close();

            conn.Close();
        }

        srcHistory.SelectParameters[0].DefaultValue = Request.QueryString["id"];
        litHeading.Text = Request.QueryString["name"];

        if (User.Identity.Name == "SHYNET\\shy")
        {
            dgHistory.AutoGenerateDeleteButton = false;
            dgHistory.AutoGenerateEditButton = false;
        }
    }

    protected void dgHistory_RowDeleting(object sender, GridViewDeleteEventArgs e)
    {
        srcHistory.DeleteParameters[0].DefaultValue = dgHistory.DataKeys[e.RowIndex].Values["transaction_type"].ToString(); // Transaction type (P or A)
        srcHistory.DeleteParameters[1].DefaultValue = dgHistory.DataKeys[e.RowIndex].Values["id"].ToString();  // id
        //TODO: Rebind main DataView in case class was deleted from currently displayed one
    }

    protected void dgHistory_RowCanceling(object sender, GridViewCancelEditEventArgs e)
    {
        // I probably don't need to do this since I'm using automatic binding
        //dgHistory.EditIndex = -1;
        //dgHistory.DataBind();
    }

    protected void dgHistory_RowEditing(object sender, GridViewEditEventArgs e)
    {

        if (dgHistory.DataKeys[e.NewEditIndex].Values["transaction_type"].ToString() == "A")
            ((BoundField)dgHistory.Columns[4]).ReadOnly = true;
        else
            ((BoundField)dgHistory.Columns[4]).ReadOnly = false;
    }

    protected void dgHistory_RowDataBound(object sender, GridViewRowEventArgs e)
    {
        if (e.Row.RowState == DataControlRowState.Edit)
        {
            DropDownList lstPaymentTypes = (DropDownList)e.Row.FindControl("lstPaymentTypes");
            if (dgHistory.DataKeys[e.Row.RowIndex].Values["transaction_type"].ToString() == "A")
                lstPaymentTypes.Visible = false;
            else
                lstPaymentTypes.Visible = true;
        }
    }

}